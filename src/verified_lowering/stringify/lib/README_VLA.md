# VLA Post-Processor for Verified ATL

This directory contains `replace_calloc.py`, an **unverified post-processor** that transforms heap-allocated intermediate arrays to stack-based Variable Length Arrays (VLAs).

## Background

The verified ATL compiler generates C code with `calloc`/`free` for intermediate arrays from `tlet` bindings:

```c
// Generated by verified compiler
float *x = calloc((N + 2) * M, sizeof(float));
// ... use x ...
free(x);
```

This heap allocation was chosen to simplify the Coq verification proofs in `src/verified_lowering/proof/`.

## The Post-Processor Solution

Rather than rewrite the verified compiler (months of Coq work), we apply a simple transformation **after** verification:

```c
// Transformed by post-processor
float x[(N + 2) * M];
// ... use x ...
// x auto-freed (VLA)
```

## Usage

### Transform all C files in current directory

```bash
python3 replace_calloc.py . -i
```

### Transform a single file

```bash
python3 replace_calloc.py input.c -o output.c
```

### Process directory recursively

```bash
python3 replace_calloc.py /path/to/dir -i -r
```

## Verification

The transformation is **tested but not formally verified**:

- ✅ All 16 equivalence tests pass with VLA versions
- ✅ Compiles without warnings with `clang -Wall`
- ✅ Original verified code remains untouched

### Run tests

```bash
cd /home/pop/Dev/Clone/verified-scheduling/src/verified_lowering/stringify
make clean
make lib        # Regenerate C files
python3 lib/replace_calloc.py lib -i
make test       # Run equivalence tests
```

Expected output:

```
blurim_blurtiles         passed
blurim_blurtwo   passed
blurpart_blurim  passed
...
(16 tests total, all should pass)
```

## What Gets Transformed

### Pattern Matching

The tool uses regex to match:

```regex
float \*(\w+) = calloc\(([^,]+), sizeof\(float\)\);
```

And replaces with:

```c
float varname[size_expr];
```

Corresponding `free()` calls are commented out.

### Statistics

Current verified ATL examples (as of transformation):

- **23 C files** processed
- **6 calloc() calls** replaced
- **6 free() calls** removed
- Files with transformations:
  - `blurtwo.c`, `blurtiles.c`, `blurtwopart.c`
  - `conv1.c`, `im2col.c`, `im2collifted.c`

## Requirements

- Python 3.6+
- C99 compiler (for VLA support)

## Trade-offs

### Advantages

- ✅ Avoids stack/heap syscall overhead
- ✅ Automatic lifetime management
- ✅ Preserves verified correctness
- ✅ Simple, reviewable transformation

### Disadvantages

- ❌ Transformation is not formally verified
- ❌ Requires C99 VLA support
- ❌ Large arrays may overflow stack (but calloc versions had same size)
- ❌ Must remember to run after regenerating C code

## Integration with Build System

To make this automatic, add to `src/verified_lowering/stringify/Makefile`:

```makefile
lib: coq MakefileLib.coq
 $(MAKE) -f MakefileLib.coq > lib/gen.out
 $(MAKE) -C lib scrub
 python3 lib/replace_calloc.py lib -i  # Apply VLA transformation
 $(MAKE) -C lib libscheds.a
```

## Technical Details

### Why VLAs are safe here

1. **Sizes are function parameters**: Runtime-known, not arbitrary
2. **Same memory usage**: VLA size = original calloc size
3. **Scoped lifetime**: Arrays don't escape function (verified in original)
4. **No recursion**: ATL lowering doesn't generate recursive functions

### Complex size expressions

The tool warns about complex expressions like:

```c
float x7[(66 - (0)) * (64 - (0))];
```

These compile fine but could be simplified. The generated code includes redundant `- (0)` from the lowering algorithm.

## Limitations

- Only handles `float` arrays (current ATL scalar type)
- Assumes `calloc` pattern from verified compiler
- Does not optimize size expressions
- Manual step (not integrated into verified pipeline)

## Future Work

- [ ] Integrate into Coq code generation (would require verification)
- [ ] Add size expression optimizer
- [ ] Support other scalar types
- [ ] Add stack usage analyzer

## References

- Original verified compiler: `src/verified_lowering/proof/ATLDeep.v`
- Heap allocation semantics: `src/verified_lowering/proof/Array.v` (line 610)
- Code generation: `src/verified_lowering/stringify/Stringify.v` (line 235)
